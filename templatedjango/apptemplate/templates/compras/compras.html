{% extends 'base/template.html' %}

{% block compras %}

{% block titulocompras %}
<title>Compras</title>
{% endblock titulocompras %}

<div class="container rounded">

  <div class="row">

    <div class="col-sm-12 col-md-12 col-lg-12 col-xl-4">

      <div class="card shadow p-3 mb-5 bg-white rounded" style="border:none;">
        <div class="card-body">
          <h5 class="card-title">¡Compras!</h5>

          <form action="compras" method="POST">
            {% csrf_token %}
            <div class="form-group">
              <select class="form-control selectpicker" name="id_insumo" data-live-search="true"
              title="Selecione un Producto" data-live-search-placeholder="Buscar..." required>
                
                {% for insumo in insumos  %}
                <option id="opcion{{insumo.id}}" value="{{insumo.id}}">{{insumo.nombre}}</option>

                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <input type="number" class="form-control"  name="cantidad"
                placeholder="Cantidad" min="0"  required>
            </div>

            <div class="form-group">
              <input type="number" class="form-control"  step="100" name="precio" placeholder="Precio" min="0" required>
            </div>

            <button type="submit" class="btn btn-outline-info float-right" >Agregar</button>
            <button style="margin-right: 10px;" type="reset" class="btn btn-outline-secondary float-right" value="Limpiar">Limpiar</button>

          </form>
        </div>
      </div>

    </div>

    <div class="col-sm-12 col-md-12 col-lg-12 col-xl-8">

      <div class="table-responsive">

        <table class="table table-hover shadow p-3 mb-5 bg-white rounded ">

          <thead>
            <tr>
              <th  scope="col">Categoria</th>
              <th  scope="col">Producto</th>
              <th  scope="col">Cantidad</th>
              <th  scope="col">Medida</th>
              <th  scope="col">Precio</th>
              <th  scope="col">Total</th>
              <th  scope="col">Acciones</th>
            </tr>
          </thead>

          <tbody>
            
            {% if compras %}
              
            {% for compra in compras  %}

            <tr class="tabla_compras">
              <td>{{compra.categoria}}</td>
              <td id="select{{compra.id_detalles_compras}}">{{compra.nombre}}</td>
              <td>{{compra.cantidad}}</td>
              <td>{{compra.unidad_medida}}</td>
              <td>{{compra.precio}}</td>
              <td class="calcular_compra">{{compra.subtotal}}</td>


              <!-- codigo para el boton de editar 
                -------------------------------------------------- -->
              <td class="small">
                {% load static %}
                <i type="button" data-toggle="modal" class="editar_icono"
                  data-target="#editar{{compra.id_detalles_compras}}"><i><img
                      src="{% static '/assets/icons/icon_edit.svg' %}" alt=""></i></i>

                <div class="modal fade" id="editar{{compra.id_detalles_compras}}" tabindex="-1" role="dialog"
                  aria-labelledby="exampleModalLabel" aria-hidden="true">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Editar Datos</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <form method="POST" action="/editar">
                          {% csrf_token %}
                          <div class="form-group">

                            <!-- ACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
                            
                            -->
                            <label for="nombre{{insumo.id}}" class="col-form-label">Producto:</label>
                            <select name="producto" id="nombre{{insumo.id}}" class="form-control selectpicker" data-live-search="true" title="Selecione un Producto" 
                            data-live-search-placeholder="Buscar...">

                              {% for insumo in insumos  %}
                              <option class="productos{{compra.id_detalles_compras}}" id="opcion{{insumo.nombre}}"
                                value="{{insumo.id}}">{{insumo.nombre}}</option>

                              {% endfor %}


                            </select>

                            <script>
                              var elements = document.getElementsByClassName(
                                'productos{{compra.id_detalles_compras}}')
                              var select = document.getElementById('select{{compra.id_detalles_compras}}')

                              for (var i = 0; i < elements.length; i++) {
                                console.log(elements[i].innerHTML)
                                if (elements[i].innerHTML == select.innerHTML) {
                                  elements[i].setAttribute('selected', 'selected');

                                }
                              }

                              console.log(select.innerHTML)
                            </script>
                          </div>
                          <div class="form-group">
                            <label for="recipient-name" class="col-form-label">Cantidad:</label>
                            <input name="cantidad" value="{{compra.cantidad}}" type="text" class="form-control"
                              id="recipient-name">
                          </div>
                          <div class="form-group">
                            <label for="recipient-name" class="col-form-label">Precio:</label>
                            <input name="precio" value="{{compra.precio}}" type="text" class="form-control"
                              id="recipient-name">
                          </div>

                          <input type="hidden" name="iden" value="{{compra.id_detalles_compras}}">

                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-outline-success">Guardar Cambios</button>
                      </div>
                      </form>
                    </div>
                  </div>
                </div>



                <!-- codigo para el boton de borrar  -->
                <!-- -------------------------------------------- -->


                <!-- Button trigger modal -->
                <i style="color: white; padding:0 10px ;" type="button" data-toggle="modal"
                  data-target="#borrar{{compra.id_detalles_compras}}">
                  {% load static %}
                  <img src="{% static '/assets/icons/circle-remove.svg' %}" alt="">
                </i>

                <!-- Modal -->
                <div class="modal fade" id="borrar{{compra.id_detalles_compras}}" tabindex="-1" role="dialog"
                  aria-labelledby="exampleModalLabel" aria-hidden="true">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Confirmación</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <form action="borrar" method="post">
                        {% csrf_token %}
                        <div class="modal-body">
                          <input type="hidden" name="id_borrar" value="{{compra.id_detalles_compras}}">
                          <span>¿Desea Eliminar este Registro?</span> 
                        </div>
                        <div class="modal-footer">

                          <button type="button" class="btn btn-outline-warning" data-dismiss="modal">Cancelar</button>
                          <button type="submit" class="btn btn-outline-danger">Borrar</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
           
            {% endif %}
              


          </tbody>
        </table>
      </div>




      <div class="totales">

        <div class="form-group">
          <input type="text" style="width: 50%;" class="form-control" id="total" placeholder="Total" readonly>
        </div>
        <div class="form-group">
          <input type="date" style="width: 50%;" class="form-control" id="fecha_parcial">
          
        </div>

      </div>

      <div class="botones">

        <form action="registrar" method="post">
          {% csrf_token %}
          {% for conjunto_compras in compras  %}
          <input type="hidden" name="id_para_compras" value="{{conjunto_compras.id_detalles_compras}}">
          {% endfor %}

          <input type="hidden" id="fecha" name="fecha">
          <input type="hidden" id="total_compra" name="total_compra">

          <script>
            // este codigo es para poder mostrar en tiempo real la cantidad total de la compra 

            var calcular_total = document.getElementsByClassName('calcular_compra')
            var suma = 0
            for (i = 0; i < calcular_total.length; i++) {
              suma += parseInt(calcular_total[i].innerHTML, 10);
            }

            total_compra = document.getElementById('total')
            total_compra.innerHTML = suma;
            total_compra.value = suma;

            total_definido = document.getElementById('total_compra')
            total_definido.value = suma

            fecha = document.getElementById('fecha')

            // el codigo de abajo es para poder poner la fecha por defecto en el input de tipo date

            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
            var yyyy = String(today.getFullYear());

            date = String(yyyy + '-' + mm + '-' + dd);
            // document.write(today);


            fecha_parcial = document.getElementById('fecha_parcial');

            // fecha_utc = date.toUTCString()
            fecha_parcial.value = date;
            fecha_parcial.defaulValue = date;
            fecha_parcial.innerHTML = date;


            console.log(date)


            // en esta funcion se cambia el vlor de la fecha al input oculto ara poer enviarlo al servidor
            function cambio() {
              fecha = document.getElementById('fecha')
              fecha_parcial = document.getElementById('fecha_parcial');
              fecha.value = fecha_parcial.value;

            }
          </script>
          
          <button type="button" class="btn btn-outline-success float-right" data-toggle="modal" data-target="#confirmar"
            onclick="cambio()">Registrar</button>

          <button style="margin-right: 10px;" type="button" class="btn btn-outline-danger float-right" data-toggle="modal" data-target="#borrar_todo"
          onclick="">Borrar Todo</button>

          <div class="modal fade" id="confirmar" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Confirmación</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <span>¿Está Seguro que Desea Registrar Esta Compra?</span> 
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-outline-success">Confirmar</button>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="borrar_todo" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Confirmación</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <span>¿Está Seguro que Desea Borrar Todos los Elementos de Esta Compra?</span> 
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-outline-success">Confirmar</button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>


  <!-- <script>
    function verificar() {
        table = document.getElementsByTagName('td')
        console.log(table.length)


        ocultar = document.getElementsByClassName('bg-light')

        if(table.length > 0){

            for (var i = 0; i < ocultar.length; i++) {

                ocultar[i].setAttribute('href', '')
            }
        }

    }

    window.onload = function () {
        verificar()
    };
</script> -->
{% load static %}
<script src="{% static '/js/functions.js' %}"></script>
</div>
{% endblock compras %}